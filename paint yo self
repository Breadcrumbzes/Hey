local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local tool
local remote

local function SafeInvoke(method, data)
	task.spawn(function()
		remote:InvokeServer(method, data)
	end)
end

local function SyncMesh(part, meshtype, meshId, scale)
	SafeInvoke("SyncMesh", {{
		Part = part,
		MeshType = meshtype,
		MeshId = meshId,
		Scale = scale   
	}})
end

local function GetF3X()
	tool = nil
	for _, v in pairs(player:GetDescendants()) do
		if v.Name == "SyncAPI" and v:FindFirstChild("ServerEndpoint") then
			tool = v.Parent
			break
		end
	end
	if not tool then
		for _, v in pairs(ReplicatedStorage:GetDescendants()) do
			if v.Name == "SyncAPI" and v:FindFirstChild("ServerEndpoint") then
				tool = v.Parent
				break
			end
		end
	end
	while not tool do
		task.wait(0.1)
		for _, v in pairs(player:GetDescendants()) do
			if v.Name == "SyncAPI" and v:FindFirstChild("ServerEndpoint") then
				tool = v.Parent
				break
			end
		end
	end
	remote = tool:WaitForChild("SyncAPI"):WaitForChild("ServerEndpoint")
end

local function kill(humanoid)
	if humanoid then
		local character = humanoid:FindFirstAncestorOfClass("Model")
		if character then
			local head = character:FindFirstChild("Head")
			if head and head:IsA("BasePart") then
				SyncMesh(head, "Head", "", head.Size)
			end
		end
	end
end

local function painter(newPart)
	task.spawn(function()
		while newPart and newPart.Parent do
			task.wait(0.01)
			local touching = workspace:GetPartsInPart(newPart)
			if touching then
				for _, hit in pairs(touching) do
					if hit:IsA("BasePart") and not hit.Anchored then
						SyncMesh(hit, "Color", "", Vector3.new())
					end
				end
			end
		end
	end)
end

local function RunImporter(char, id)
	local hrp = char:WaitForChild("HumanoidRootPart")
	GetF3X()
	local obj = game:GetObjects("rbxassetid://" .. id)[1]
	obj.Parent = workspace
	obj:PivotTo(hrp.CFrame * CFrame.new(0, 0, -5))
	task.wait(0.1)
	for _, basepart in pairs(obj:GetDescendants()) do
		if basepart:IsA("BasePart") then
			task.spawn(function()
				SyncMesh(basepart, "Part", "", basepart.Size)
				if basepart.Name == "ColorBrick" then
					painter(basepart)
				end
				basepart:Destroy()
			end)
		end
	end
	obj:Destroy()
end

player.CharacterAdded:Connect(function(char)
	task.spawn(function()
		RunImporter(char)
	end)
end)

if player.Character then
	RunImporter(player.Character)
end

for i,v in pairs(workspace:GetDescendants()) do
	if v:IsA("Humanoid") then
		v.Died:Connect(function()
			kill(v)
		end)
	end
end
workspace.DescendantAdded:Connect(function(v)
	if v:IsA("Humanoid") then
		v.Died:Connect(function()
			kill(v)
		end)
	end
end)
